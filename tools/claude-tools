#!/bin/bash
# description: One-command interface to all Claude Tool Integration features
# version: 1.0.0
# category: integration

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_banner() {
    echo "ğŸ¤– =============================================== ğŸ¤–"
    echo "    CLAUDE TOOL INTEGRATION COMMAND CENTER"
    echo "ğŸ¤– =============================================== ğŸ¤–"
    echo ""
}

show_status() {
    echo "ğŸ“Š SYSTEM STATUS"
    echo "=================="
    
    # Check if services are running
    if curl -s http://localhost:7000 > /dev/null 2>&1; then
        echo "âœ… Claude Bridge: RUNNING (http://localhost:7000)"
    else
        echo "âŒ Claude Bridge: STOPPED"
    fi
    
    if curl -s http://localhost:8000 > /dev/null 2>&1; then
        echo "âœ… Converter API: RUNNING (http://localhost:8000)"
    else
        echo "âŒ Converter API: STOPPED"
    fi
    
    echo ""
}

show_commands() {
    echo "ğŸš€ AVAILABLE COMMANDS"
    echo "====================="
    echo "  claude-tools start       # Start the complete system"
    echo "  claude-tools stop        # Stop all services"
    echo "  claude-tools test        # Test the system"
    echo "  claude-tools tools       # List all available tools"
    echo "  claude-tools health      # Check tool health"
    echo "  claude-tools demo        # Run a demo"
    echo "  claude-tools status      # Show this status"
    echo ""
}

show_quick_access() {
    echo "âš¡ QUICK ACCESS"
    echo "==============="
    echo "  ğŸŒ Bridge API:     http://localhost:7000"
    echo "  ğŸ“‹ Tool List:      http://localhost:7000/tools"
    echo "  ğŸ¥ Health Check:   http://localhost:7000/health"
    echo "  ğŸ“š API Docs:       http://localhost:8000/docs"
    echo ""
}

case "${1:-status}" in
    start)
        echo "ğŸš€ Starting Claude Tool Integration System..."
        exec "$SCRIPT_DIR/start_claude_bridge.sh"
        ;;
    
    stop)
        echo "ğŸ›‘ Stopping Claude Tool Integration System..."
        exec "$SCRIPT_DIR/stop_claude_bridge.sh"
        ;;
    
    test)
        echo "ğŸ§ª Testing Claude Tool Integration..."
        if ! curl -s http://localhost:7000 > /dev/null 2>&1; then
            echo "âŒ Bridge not running. Start with: claude-tools start"
            exit 1
        fi
        
        echo "âœ… Bridge is running"
        echo "ğŸ”„ Testing tool discovery..."
        tool_count=$(curl -s http://localhost:7000/tools | python -c "import sys, json; print(len(json.load(sys.stdin)['tools']))" 2>/dev/null || echo "0")
        echo "ğŸ“Š Found $tool_count tools"
        
        echo "ğŸ§ª Running client test..."
        cd "$SCRIPT_DIR" && python claude_client.py
        ;;
    
    tools)
        echo "ğŸ“‹ Fetching available tools..."
        if curl -s http://localhost:7000 > /dev/null 2>&1; then
            curl -s http://localhost:7000/tools | python -c "
import sys, json
try:
    data = json.load(sys.stdin)
    tools = data['tools']
    categories = {}
    for tool in tools:
        cat = tool.get('category', 'other')
        if cat not in categories:
            categories[cat] = []
        categories[cat].append(tool)
    
    print(f'ğŸ“Š Total Tools: {len(tools)}')
    print('=' * 50)
    for category, cat_tools in categories.items():
        print(f'\nğŸ“‚ {category.upper()} ({len(cat_tools)} tools)')
        print('-' * 40)
        for tool in cat_tools:
            status = 'âœ…' if tool['status'] == 'active' else 'âŒ'
            print(f'  {status} {tool[\"name\"]:<20} - {tool[\"description\"][:50]}...')
except:
    print('âŒ Failed to parse tools data')
"
        else
            echo "âŒ Bridge not running. Start with: claude-tools start"
        fi
        ;;
    
    health)
        echo "ğŸ¥ Checking system health..."
        if curl -s http://localhost:7000 > /dev/null 2>&1; then
            curl -s http://localhost:7000/health | python -c "
import sys, json
try:
    data = json.load(sys.stdin)
    print(f'ğŸŒ¡ï¸  Overall Health: {data[\"overall_health\"].upper()}')
    print(f'âœ… Healthy Tools: {data[\"healthy_tools\"]}')
    print(f'âŒ Unhealthy Tools: {data[\"unhealthy_tools\"]}')
    print(f'ğŸ“Š Total Tools: {data[\"total_tools\"]}')
except:
    print('âŒ Failed to parse health data')
"
        else
            echo "âŒ Bridge not running. Start with: claude-tools start"
        fi
        ;;
    
    demo)
        echo "ğŸª Running Claude Tool Integration Demo..."
        if ! curl -s http://localhost:7000 > /dev/null 2>&1; then
            echo "âŒ Bridge not running. Starting it first..."
            "$SCRIPT_DIR/start_claude_bridge.sh" &
            echo "â³ Waiting for bridge to start..."
            sleep 5
        fi
        
        echo ""
        echo "ğŸ” Demo 1: Document Analysis"
        echo "============================="
        curl -s -X POST http://localhost:7000/execute \
            -H "Content-Type: application/json" \
            -d '{"tool_name": "document_analyzer", "parameters": {"text": "This is a demo document for Claude Tool Integration! It has multiple sentences and shows how Claude can analyze text.", "content_type": "txt"}}' | \
            python -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if data['success']:
        result = data['result']['data']
        print(f'ğŸ“Š Word Count: {result[\"basic_stats\"][\"word_count\"]}')
        print(f'ğŸ“– Reading Level: {result[\"readability\"][\"reading_level\"]}')
        print(f'â±ï¸  Execution Time: {data[\"execution_time_ms\"]:.1f}ms')
    else:
        print(f'âŒ Error: {data[\"message\"]}')
except Exception as e:
    print(f'âŒ Demo failed: {e}')
"
        
        echo ""
        echo "ğŸ”„ Demo 2: Format Conversion"
        echo "============================"
        curl -s -X POST http://localhost:7000/execute \
            -H "Content-Type: application/json" \
            -d '{"tool_name": "format_converter", "parameters": {"content": "name,age,city\nAlice,25,NYC\nBob,30,LA", "from_format": "csv", "to_format": "json"}}' | \
            python -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if data['success']:
        # Handle nested data structure
        result_data = data['result']
        if 'data' in result_data:
            conversion_data = result_data['data']
        else:
            conversion_data = result_data
        
        print(f'âœ… Converted CSV to JSON successfully')
        if 'conversion_info' in conversion_data:
            info = conversion_data['conversion_info']
            print(f'ğŸ“„ Original size: {info[\"original_size_chars\"]} chars')
            print(f'ğŸ“„ Converted size: {info[\"converted_size_chars\"]} chars')
        print(f'â±ï¸  Execution Time: {data[\"execution_time_ms\"]:.1f}ms')
    else:
        print(f'âŒ Error: {data[\"message\"]}')
except Exception as e:
    print(f'âŒ Demo failed: {e}')
"
        
        echo ""
        echo "ğŸ‰ Demo complete! Claude can now use all your tools instantly!"
        ;;
    
    status|*)
        show_banner
        show_status
        show_commands
        show_quick_access
        echo "ğŸ’¡ TIP: Run 'claude-tools start' to begin, then 'claude-tools demo' to see it in action!"
        echo ""
        ;;
esac